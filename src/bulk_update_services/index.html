<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulk Update Services & Code Snippet Example</title>
    <link rel="stylesheet" href="styles.css">
    <script>
      // Function to copy text from the preformatted block
      function copyToClipboard(id) {
        const str = document.getElementById(id).innerText;
        const el = document.createElement('textarea');
        el.value = str;
        document.body.appendChild(el);
        el.select();
        document.execCommand('copy');
        document.body.removeChild(el);
        alert('Copied to clipboard!');
      }
    </script>
</head>
<body>

<div id="sidebar-placeholder"></div>

<main>
    <section id="bulk-update">
        <h2>Bulk Update Services</h2>
        <form id="bulkUpdateForm">
            <label for="authToken">Authorization Token:</label>
            <input type="text" id="authToken" required>
            
            <div class="expandable-field">
                <button type="button" onclick="toggleExpandableFields()">+</button>
                <div class="fields" style="display: none;">
                    <label for="autoAlert">Auto Alert Responding Team:</label>
                    <select id="autoAlert">
                        <option value="true">True</option>
                        <option value="false">False</option>
                    </select>

                    <label for="autoAdd">Auto Add Responding Team:</label>
                    <select id="autoAdd">
                        <option value="true">True</option>
                        <option value="false">False</option>
                    </select>
                </div>
            </div>
            <button type="submit">Submit</button>
        </form>
        <!-- Code snippets toggle box -->
        <div class="code-snippets">
            <button id="btnNodeJs">Node.js</button>
            <button id="btnPython">Python</button>
            <pre id="codeSnippetNodeJs" class="code-snippet" style="display:none;"><code>
                const axios = require('axios');
                const readline = require('readline').createInterface({
                  input: process.stdin,
                  output: process.stdout
                });
                
                // Function to prompt for user input
                function prompt(query) {
                  return new Promise((resolve) => {
                    readline.question(query, resolve);
                  });
                }
                
                async function updateServices() {
                  try {
                    const authToken = await prompt('Enter Authorization Token: ');
                    const autoAlertInput = await prompt('Auto Alert Responding Team (true/false): ');
                    const autoAddInput = await prompt('Auto Add Responding Team (true/false): ');
                    
                    const autoAlert = autoAlertInput.toLowerCase() === 'true';
                    const autoAdd = autoAddInput.toLowerCase() === 'true';
                
                    const apiEndpoint = 'https://api.firehydrant.io/v1/services';
                    const bearerToken = `Bearer ${authToken}`;
                
                    const servicesResponse = await axios.get(apiEndpoint, {
                      headers: { Authorization: bearerToken }
                    });
                    console.log('Services response data:', servicesResponse.data);
                    
                    const services = servicesResponse.data.data; 
                    if (!Array.isArray(services)) {
                      throw new Error('Expected services to be an array');
                    }
                
                    const updatePromises = services.map(service =>
                      axios.patch(`${apiEndpoint}/${service.id}`, {
                        alert_on_add: autoAlert,
                        auto_add_responding_team: autoAdd
                      }, {
                        headers: { Authorization: bearerToken }
                      })
                    );
                
                    const results = await Promise.allSettled(updatePromises);
                    results.forEach(result => {
                      if (result.status === 'fulfilled') {
                        console.log('Update success for service:', result.value.data);
                      } else {
                        console.error('Update failed for service:', result.reason);
                      }
                    });
                
                    const successes = results.filter(result => result.status === 'fulfilled');
                    console.log(`Services updated successfully: ${successes.length}`);
                    
                  } catch (error) {
                    console.error('Error details:', error.response?.data || error.message);
                  } finally {
                    readline.close();
                  }
                }
                
                updateServices();
            </code></pre>
            <pre id="codeSnippetPython" class="code-snippet" style="display:none;"></pre>
        </div>
    </section>

    <!-- Include your Node.js Code Snippet section here -->
    <section>
      <h2>Node.js Code Snippet</h2>
      <button onclick="copyToClipboard('nodeSnippet')">Copy to Clipboard</button>
      <pre id="nodeSnippet"><code>
// (Your Node.js snippet code here)
      </code></pre>
    </section>
</main>

<script>
// Fetch the sidebar content and include it into the sidebar placeholder
fetch('../sidebar.html') // Adjusted path, assuming the server serves from `src` as root
  .then(response => {
    if (!response.ok) {
      throw new Error('Network response was not ok - status: ' + response.status);
    }
    return response.text();
  })
  .then(data => {
    document.getElementById('sidebar-placeholder').innerHTML = data;
  })
  .catch(error => {
    console.error('Could not load sidebar:', error);
  });
</script>
<script src="script.js"></script>
</body>
</html>
